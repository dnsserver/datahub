<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>&lt;no title&gt; &mdash; DH_Doc 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="DH_Doc 0.1 documentation" href="../../../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">DH_Doc 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
    <h1> Generated by Sphinx </h1>
    
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <p>#
# this file has no deps on Scorpion
#
import os
import re
import time
import json
import decimal
import md5
import pdb
import psycopg2
import traceback</p>
<p>from collections import *
from datetime import datetime</p>
<p>from scorpionsql.errfunc import *
from scorpionsql.sql import *</p>
<p># JSON Encoder
class SummaryEncoder(json.JSONEncoder):</p>
<blockquote>
<div><dl class="docutils">
<dt>def default(self, o):</dt>
<dd><dl class="first docutils">
<dt>if isinstance(o, float):</dt>
<dd><dl class="first last docutils">
<dt>if o == float(&#8216;inf&#8217;):</dt>
<dd>return 1e100</dd>
<dt>elif o == float(&#8216;-inf&#8217;):</dt>
<dd>return -1e100</dd>
</dl>
</dd>
<dt>if isinstance(o, decimal.Decimal):</dt>
<dd>return float(o)</dd>
<dt>if hasattr(o, &#8216;isoformat&#8217;):</dt>
<dd><p class="first">s =  o.isoformat()
if not s.endswith(&#8220;Z&#8221;):</p>
<blockquote>
<div>s += &#8216;Z&#8217;</div></blockquote>
<p class="last">return s</p>
</dd>
</dl>
<p class="last">return super(SummaryEncoder, self).default(o)</p>
</dd>
</dl>
</div></blockquote>
<dl class="docutils">
<dt>def where_to_sql(where_json, negate=False):</dt>
<dd><p class="first">is_type = lambda s, types: any([t in s for t in types])
l = []
args = []
for clause_json in where_json:</p>
<blockquote>
<div><dl class="docutils">
<dt>if &#8216;sql&#8217; in clause_json:</dt>
<dd>l.append(clause_json[&#8216;sql&#8217;])
continue</dd>
</dl>
<p>ctype = clause_json[&#8216;type&#8217;]
col = clause_json[&#8216;col&#8217;]
vals = clause_json[&#8216;vals&#8217;]</p>
<p>if not vals: continue</p>
<dl class="docutils">
<dt>if is_type(ctype, [&#8216;num&#8217;, &#8216;int&#8217;, &#8216;float&#8217;, &#8216;double&#8217;, &#8216;date&#8217;, &#8216;time&#8217;]):</dt>
<dd>q = &#8220;%%s &lt;= %s and %s &lt;= %%s&#8221; % (col, col)
args.extend(vals)</dd>
<dt>else:</dt>
<dd><p class="first">tmp = []
vals = list(vals)
if None in vals:</p>
<blockquote>
<div>tmp.append(&#8220;(%s is null)&#8221; % col)</div></blockquote>
<p>realvals = list(filter(lambda v: v is not None, vals))
if len(realvals) == 1:</p>
<blockquote>
<div>tmp.append(&#8220;(%s = %%s)&#8221; % col)
args.append(realvals[0])</div></blockquote>
<dl class="docutils">
<dt>elif len(realvals):</dt>
<dd>tmp.append(&#8220;(%s in %%s)&#8221; % col)
args.append(tuple(list(realvals)))</dd>
</dl>
<p class="last">q = &#8216; or &#8216;.join(tmp)</p>
</dd>
</dl>
<p>l.append(q)</p>
</div></blockquote>
<p>q = &#8216; and &#8216;.join(filter(bool, l))
if negate and q:</p>
<blockquote>
<div>q = &#8220;not(%s)&#8221; % q</div></blockquote>
<p class="last">return q, args</p>
</dd>
<dt>__agg2f__ = {</dt>
<dd>&#8216;avg&#8217; : AvgErrFunc,
&#8216;std&#8217; : StdErrFunc,
&#8216;stddev&#8217; : StdErrFunc,
&#8216;stddev_samp&#8217;: StdErrFunc,
&#8216;stddev_pop&#8217;: StdErrFunc,
&#8216;min&#8217; : MinErrFunc,
&#8216;max&#8217; : MaxErrFunc,
&#8216;sum&#8217; : SumErrFunc,
&#8216;corr&#8217; : CorrErrFunc,
&#8216;count&#8217; : CountErrFunc,
&#8216;abs&#8217; : AbsErrFunc</dd>
</dl>
<p>}</p>
<dl class="docutils">
<dt>def parse_agg(s):</dt>
<dd><p class="first">&#8220;&#8221;&#8221;
parse an aggregation SELECT clause e.g., avg(temp) as foo
into dictionary of function name, column, and alias components
&#8220;&#8221;&#8221;
print s
p = re.compile(&#8216;(?P&lt;func&gt;w+)(s*(?P&lt;col&gt;[w,s]+)s*)s*(ass+(?P&lt;alias&gt;w+))?&#8217;)
d = p.match(s).groupdict()
klass = __agg2f__[d[&#8216;func&#8217;].strip()]
expr = str(d[&#8216;col&#8217;])
cols = [col.strip() for col in expr.split(&#8216;,&#8217;)]
varlist = [Var(col) for col in cols]
print klass
print cols
print varlist
func = klass(varlist)
return {</p>
<blockquote>
<div>&#8216;fname&#8217;: d[&#8216;func&#8217;],
&#8216;func&#8217;: func,
&#8216;cols&#8217;: cols,
&#8216;alias&#8217;: d.get(&#8216;alias&#8217;, &#8216;&#8217;) or d[&#8216;func&#8217;]</div></blockquote>
<p class="last">}</p>
</dd>
<dt>def expr_from_nonagg(s):</dt>
<dd><p class="first">&#8220;&#8221;&#8221;
remove alias component of a nonaggregation SELECT clause
&#8220;&#8221;&#8221;
if &#8216; as &#8216; in s:</p>
<blockquote>
<div>return &#8216; as &#8216;.join(s.split(&#8216; as &#8216;)[:-1])</div></blockquote>
<p class="last">return s</p>
</dd>
<dt>def create_sql_obj(db, qjson):</dt>
<dd><p class="first">x = qjson[&#8216;x&#8217;]
ys = qjson[&#8216;ys&#8217;]
#sql = qjson[&#8216;query&#8217;]
dbname = qjson[&#8216;db&#8217;]
table = qjson[&#8216;table&#8217;]
negate = qjson.get(&#8216;negate&#8217;, False)
where_json = qjson.get(&#8216;where&#8217;, []) or []
basewheres_json = qjson.get(&#8216;basewheres&#8217;, []) or []</p>
<p>where, args = where_to_sql(where_json, negate)
basewheres, baseargs = where_to_sql(basewheres_json, False)
where = &#8216; and &#8216;.join(filter(bool, [where, basewheres]))
args.extend(baseargs)</p>
<p>select = Select()
nonagg = SelectExpr(x[&#8216;alias&#8217;], [x[&#8216;col&#8217;]], x[&#8216;expr&#8217;], x[&#8216;col&#8217;])
select.append(nonagg)
for y in ys:</p>
<blockquote>
<div>d = parse_agg(y[&#8216;expr&#8217;])
agg = SelectAgg(y[&#8216;alias&#8217;], d[&#8216;func&#8217;], d[&#8216;cols&#8217;], y[&#8216;expr&#8217;], d[&#8216;cols&#8217;][0])
select.append(agg)</div></blockquote>
<dl class="docutils">
<dt>parsed = Query(</dt>
<dd>db,
select,
[table],
[where],
[x[&#8216;expr&#8217;]],
[expr_from_nonagg(x[&#8216;expr&#8217;])]</dd>
</dl>
<p>)</p>
<p class="last">return parsed, args</p>
</dd>
<dt>def pick(iterable, key):</dt>
<dd>return [item[key] for item in iterable]</dd>
</dl>


          </div>
        </div>
      </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../_sources/src/apps/dbwipes/util.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, MIT Living Lab.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.4</a>
      
      |
      <a href="../../../_sources/src/apps/dbwipes/util.txt"
          rel="nofollow">Page source</a></li>
    </div>

    

    
  </body>
</html>