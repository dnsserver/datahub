<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>&lt;no title&gt; &mdash; DH_Doc 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="DH_Doc 0.1 documentation" href="../../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">DH_Doc 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
    <h1> Generated by Sphinx </h1>
    
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <p>import codecs
import collections
import csv
import json
import os
import re
import sys
import urllib
import uuid</p>
<p>from django.core.context_processors import csrf
from django.db.utils import IntegrityError
from django.http import *
from django.shortcuts import render_to_response
from django.utils.http import urlquote_plus
from django.views.decorators.csrf import csrf_exempt</p>
<p>from thrift.protocol import TBinaryProtocol
from thrift.protocol import TJSONProtocol
from thrift.transport import TTransport
from thrift.transport.TTransport import TMemoryBuffer</p>
<p>from account.auth import *
from account.manager import *
from core.db.manager import DataHubManager
from datahub import DataHub
from datahub.account import AccountService
from service.handler import DataHubHandler
from utils import *</p>
<p>&#8216;&#8217;&#8217;
&#64;author: Anant Bhardwaj
&#64;date: Mar 21, 2013</p>
<p>Datahub Web Handler
&#8216;&#8217;&#8216;</p>
<p>handler = DataHubHandler()
core_processor = DataHub.Processor(handler)
account_processor = AccountService.Processor(handler)</p>
<dl class="docutils">
<dt>def home(request):</dt>
<dd><dl class="first last docutils">
<dt>try:</dt>
<dd><p class="first">login = get_login(request)
if login:</p>
<blockquote>
<div>return HttpResponseRedirect(&#8216;/browse/%s&#8217; %(login))</div></blockquote>
<dl class="last docutils">
<dt>else:</dt>
<dd>return HttpResponseRedirect(&#8216;/www&#8217;)</dd>
</dl>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(</dt>
<dd>json.dumps({&#8216;error&#8217;: str(e)}),
content_type=&#8221;application/json&#8221;)</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p># just for backward compatibility
def about(request):</p>
<blockquote>
<div>return HttpResponseRedirect(&#8216;/www&#8217;)</div></blockquote>
<p>&#8216;&#8217;&#8217;
APIs and Services
&#8216;&#8217;&#8216;</p>
<p>&#64;csrf_exempt
def service_core_binary(request):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">iprot = TBinaryProtocol.TBinaryProtocol(TMemoryBuffer(request.body))
oprot = TBinaryProtocol.TBinaryProtocol(TMemoryBuffer())
core_processor.process(iprot, oprot)
resp = HttpResponse(oprot.trans.getvalue())</p>
<dl class="docutils">
<dt>try:</dt>
<dd>resp[&#8216;Access-Control-Allow-Origin&#8217;] = request.META[&#8216;HTTP_ORIGIN&#8217;]</dd>
<dt>except:</dt>
<dd>pass</dd>
</dl>
<p class="last">return resp</p>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(</dt>
<dd>json.dumps({&#8216;error&#8217;: str(e)}),
content_type=&#8221;application/json&#8221;)</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#64;csrf_exempt
def service_account_binary(request):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">iprot = TBinaryProtocol.TBinaryProtocol(TMemoryBuffer(request.body))
oprot = TBinaryProtocol.TBinaryProtocol(TMemoryBuffer())
account_processor.process(iprot, oprot)
resp = HttpResponse(oprot.trans.getvalue())</p>
<dl class="docutils">
<dt>try:</dt>
<dd>resp[&#8216;Access-Control-Allow-Origin&#8217;] = request.META[&#8216;HTTP_ORIGIN&#8217;]</dd>
<dt>except:</dt>
<dd>pass</dd>
</dl>
<p class="last">return resp</p>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(</dt>
<dd>json.dumps({&#8216;error&#8217;: str(e)}),
content_type=&#8221;application/json&#8221;)</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#64;csrf_exempt
def service_core_json(request):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">iprot = TJSONProtocol.TJSONProtocol(TMemoryBuffer(request.body))
oprot = TJSONProtocol.TJSONProtocol(TMemoryBuffer())
core_processor.process(iprot, oprot)
resp = HttpResponse(</p>
<blockquote>
<div>oprot.trans.getvalue(),
content_type=&#8221;application/json&#8221;)</div></blockquote>
<dl class="docutils">
<dt>try:</dt>
<dd>resp[&#8216;Access-Control-Allow-Origin&#8217;] = request.META[&#8216;HTTP_ORIGIN&#8217;]</dd>
<dt>except:</dt>
<dd>pass</dd>
</dl>
<p class="last">return resp</p>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(</dt>
<dd>json.dumps({&#8216;error&#8217;: str(e)}),
content_type=&#8221;application/json&#8221;)</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#8216;&#8217;&#8217;
Repository Base
&#8216;&#8217;&#8216;</p>
<p>&#64;login_required
def user(request, repo_base):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">login = get_login(request)</p>
<p>res = DataHubManager.has_base_privilege(login, repo_base, &#8216;CONNECT&#8217;)
if not (res and res[&#8216;tuples&#8217;][0][0]):</p>
<blockquote>
<div>raise Exception(&#8216;Access denied. Missing required privileges.&#8217;)</div></blockquote>
<p>manager = DataHubManager(user=repo_base)
res = manager.list_repos()
repos = [t[0] for t in res[&#8216;tuples&#8217;]]</p>
<p>visible_repos = []</p>
<dl class="last docutils">
<dt>for repo in repos:</dt>
<dd><p class="first">res = manager.list_collaborators(repo_base, repo)</p>
<p>collaborators = [(c[0].split(&#8216;=&#8217;)[0]).strip() for c in res[&#8216;tuples&#8217;]]
collaborators = filter(lambda x: x!=&#8217;&#8217; and x!=repo_base, collaborators)</p>
<dl class="docutils">
<dt>if login not in collaborators and login != repo_base:</dt>
<dd>continue</dd>
<dt>visible_repos.append({</dt>
<dd>&#8216;name&#8217;:repo,
&#8216;owner&#8217;: repo_base,
&#8216;public&#8217;: True if &#8216;PUBLIC&#8217; in collaborators else False,
&#8216;collaborators&#8217;: collaborators,
&#8216;collaborators_str&#8217;: &#8216;, &#8216;.join(collaborators),
&#8216;num_collaborators&#8217;: len(collaborators)</dd>
</dl>
<p class="last">})</p>
</dd>
<dt>return render_to_response(&#8220;user-browse.html&#8221;, {</dt>
<dd>&#8216;login&#8217;: get_login(request),
&#8216;repo_base&#8217;: repo_base,
&#8216;repos&#8217;: visible_repos})</dd>
</dl>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(json.dumps(</dt>
<dd>{&#8216;error&#8217;: str(e)}),
content_type=&#8221;application/json&#8221;)</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#8216;&#8217;&#8217;
Repository
&#8216;&#8217;&#8216;</p>
<p>&#64;login_required
def repo(request, repo_base, repo):</p>
<blockquote>
<div><dl class="docutils">
<dt>return HttpResponseRedirect(</dt>
<dd>&#8216;/browse/%s/%s/tables&#8217; %(repo_base, repo))</dd>
</dl>
</div></blockquote>
<p>&#64;login_required
def repo_tables(request, repo_base, repo):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">login = get_login(request)</p>
<p>res = DataHubManager.has_repo_privilege(login, repo_base, repo, &#8216;USAGE&#8217;)
if not (res and res[&#8216;tuples&#8217;][0][0]):</p>
<blockquote>
<div>raise Exception(&#8216;Access denied. Missing required privileges.&#8217;)</div></blockquote>
<p>manager = DataHubManager(user=repo_base)</p>
<p># get base_tables for a given repo
res = manager.list_tables(repo)
base_tables = [t[0] for t in res[&#8216;tuples&#8217;]]</p>
<p># get views for a given repo
res = manager.list_views(repo)
views = [t[0] for t in res[&#8216;tuples&#8217;]]</p>
<dl class="docutils">
<dt>res = {</dt>
<dd>&#8216;login&#8217;: get_login(request),
&#8216;repo_base&#8217;: repo_base,
&#8216;repo&#8217;: repo,
&#8216;base_tables&#8217;: base_tables,
&#8216;views&#8217;: views}</dd>
</dl>
<p class="last">res.update(csrf(request))
return render_to_response(&#8220;repo-browse-tables.html&#8221;, res)</p>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(json.dumps(</dt>
<dd>{&#8216;error&#8217;: str(e)}),
content_type=&#8221;application/json&#8221;)</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#64;login_required
def repo_files(request, repo_base, repo):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">login = get_login(request)</p>
<p>res = DataHubManager.has_repo_privilege(login, repo_base, repo, &#8216;USAGE&#8217;)
if not (res and res[&#8216;tuples&#8217;][0][0]):</p>
<blockquote>
<div>raise Exception(&#8216;Access denied. Missing required privileges.&#8217;)</div></blockquote>
<p>repo_dir = &#8216;/user_data/%s/%s&#8217; %(repo_base, repo)
if not os.path.exists(repo_dir):</p>
<blockquote>
<div>os.makedirs(repo_dir)</div></blockquote>
<p>uploaded_files = [f for f in os.listdir(repo_dir)]</p>
<dl class="docutils">
<dt>res = {</dt>
<dd>&#8216;login&#8217;: get_login(request),
&#8216;repo_base&#8217;: repo_base,
&#8216;repo&#8217;: repo,
&#8216;files&#8217;: uploaded_files}</dd>
</dl>
<p class="last">res.update(csrf(request))
return render_to_response(&#8220;repo-browse-files.html&#8221;, res)</p>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(json.dumps(</dt>
<dd>{&#8216;error&#8217;: str(e)}),
content_type=&#8221;application/json&#8221;)</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#64;login_required
def repo_cards(request, repo_base, repo):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">login = get_login(request)</p>
<p>res = DataHubManager.has_repo_privilege(login, repo_base, repo, &#8216;USAGE&#8217;)
if not (res and res[&#8216;tuples&#8217;][0][0]):</p>
<blockquote>
<div>raise Exception(&#8216;Access denied. Missing required privileges.&#8217;)</div></blockquote>
<dl class="docutils">
<dt>cards = Card.objects.all().filter(</dt>
<dd>repo_base=repo_base, repo_name=repo)</dd>
</dl>
<p>cards = [c.card_name for c in cards]</p>
<dl class="docutils">
<dt>res = {</dt>
<dd>&#8216;login&#8217;: get_login(request),
&#8216;repo_base&#8217;: repo_base,
&#8216;repo&#8217;: repo,
&#8216;cards&#8217;: cards}</dd>
</dl>
<p class="last">res.update(csrf(request))
return render_to_response(&#8220;repo-browse-cards.html&#8221;, res)</p>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(json.dumps(</dt>
<dd>{&#8216;error&#8217;: str(e)}),
content_type=&#8221;application/json&#8221;)</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#64;login_required
def repo_dashboards(request, repo_base, repo):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">login = get_login(request)</p>
<p>res = DataHubManager.has_repo_privilege(login, repo_base, repo, &#8216;USAGE&#8217;)
if not (res and res[&#8216;tuples&#8217;][0][0]):</p>
<blockquote>
<div>raise Exception(&#8216;Access denied. Missing required privileges.&#8217;)</div></blockquote>
<dl class="docutils">
<dt>res = {</dt>
<dd>&#8216;login&#8217;: get_login(request),
&#8216;repo_base&#8217;: repo_base,
&#8216;repo&#8217;: repo,
&#8216;dashboards&#8217;: []}</dd>
</dl>
<p class="last">res.update(csrf(request))
return render_to_response(&#8220;repo-browse-dashboards.html&#8221;, res)</p>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(json.dumps(</dt>
<dd>{&#8216;error&#8217;: str(e)}),
content_type=&#8221;application/json&#8221;)</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#64;login_required
def repo_create(request, repo_base):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">login = get_login(request)
if request.method == &#8220;POST&#8221;:</p>
<blockquote>
<div><dl class="docutils">
<dt>if login != repo_base:</dt>
<dd><dl class="first last docutils">
<dt>raise Exception(</dt>
<dd>&#8216;Permission denied. &#8216;
&#8216;%s can&#8217;t create new repository in %s.&#8217; %(login, repo_base))</dd>
</dl>
</dd>
</dl>
<p>repo = request.POST[&#8216;repo&#8217;]
manager = DataHubManager(user=repo_base)
manager.create_repo(repo)</p>
<p>return HttpResponseRedirect(&#8216;/browse/%s&#8217; %(repo_base))</p>
</div></blockquote>
<dl class="last docutils">
<dt>else:</dt>
<dd>res = {&#8216;repo_base&#8217;: repo_base, &#8216;login&#8217;:login}
res.update(csrf(request))
return render_to_response(&#8220;repo-create.html&#8221;, res)</dd>
</dl>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(json.dumps(</dt>
<dd>{&#8216;error&#8217;: str(e)}),
content_type=&#8221;application/json&#8221;)</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#64;login_required
def repo_delete(request, repo_base, repo):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">login = get_login(request)</p>
<dl class="docutils">
<dt>if login != repo_base:</dt>
<dd><dl class="first last docutils">
<dt>raise Exception(</dt>
<dd>&#8216;Permission denied. &#8216;
&#8216;%s can&#8217;t delete repository %s in %s.&#8217; %(login, repo, repo_base))</dd>
</dl>
</dd>
</dl>
<p class="last">manager = DataHubManager(user=repo_base)
manager.delete_repo(repo=repo, force=True)
return HttpResponseRedirect(&#8216;/browse/%s&#8217; %(repo_base))</p>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(</dt>
<dd><dl class="first docutils">
<dt>json.dumps(</dt>
<dd>{&#8216;error&#8217;: str(e)}),</dd>
</dl>
<p class="last">content_type=&#8221;application/json&#8221;)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#64;login_required
def repo_settings(request, repo_base, repo):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">login = get_login(request)
res = DataHubManager.has_repo_privilege(login, repo_base, repo, &#8216;CREATE&#8217;)</p>
<dl class="docutils">
<dt>if not (res and res[&#8216;tuples&#8217;][0][0]):</dt>
<dd>raise Exception(&#8216;Access denied. Missing required privileges.&#8217;)</dd>
</dl>
<p>manager = DataHubManager(user=repo_base)
res = manager.list_collaborators(repo_base, repo)</p>
<p>collaborators = [(c[0].split(&#8216;=&#8217;)[0]).strip() for c in res[&#8216;tuples&#8217;]]
collaborators = filter(lambda x: x!=&#8217;&#8217; and x!=repo_base, collaborators)</p>
<dl class="docutils">
<dt>res = {</dt>
<dd>&#8216;login&#8217;: get_login(request),
&#8216;repo_base&#8217;: repo_base,
&#8216;repo&#8217;: repo,
&#8216;collaborators&#8217;: collaborators}</dd>
</dl>
<p class="last">res.update(csrf(request))
return render_to_response(&#8220;repo-settings.html&#8221;, res)</p>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(json.dumps(</dt>
<dd>{&#8216;error&#8217;: str(e)}),
content_type=&#8221;application/json&#8221;)</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#64;login_required
def repo_collaborators_add(request, repo_base, repo):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">login = get_login(request)
res = DataHubManager.has_repo_privilege(login, repo_base, repo, &#8216;CREATE&#8217;)</p>
<dl class="docutils">
<dt>if not (res and res[&#8216;tuples&#8217;][0][0]):</dt>
<dd>raise Exception(&#8216;Access denied. Missing required privileges.&#8217;)</dd>
</dl>
<p>username = request.POST[&#8216;collaborator_username&#8217;]
manager = DataHubManager(user=repo_base)
manager.add_collaborator(</p>
<blockquote>
<div>repo, username, privileges=[&#8216;SELECT&#8217;, &#8216;INSERT&#8217;, &#8216;UPDATE&#8217;])</div></blockquote>
<p class="last">return HttpResponseRedirect(&#8216;/settings/%s/%s&#8217; %(repo_base, repo))</p>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(</dt>
<dd><dl class="first docutils">
<dt>json.dumps(</dt>
<dd>{&#8216;error&#8217;: str(e)}),</dd>
</dl>
<p class="last">content_type=&#8221;application/json&#8221;)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#64;login_required
def repo_collaborators_remove(request, repo_base, repo, username):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">login = get_login(request)
res = DataHubManager.has_repo_privilege(login, repo_base, repo, &#8216;CREATE&#8217;)</p>
<dl class="docutils">
<dt>if not (res and res[&#8216;tuples&#8217;][0][0]):</dt>
<dd>raise Exception(&#8216;Access denied. Missing required privileges.&#8217;)</dd>
</dl>
<p class="last">manager = DataHubManager(user=repo_base)
manager.delete_collaborator(repo, username)
return HttpResponseRedirect(&#8216;/settings/%s/%s&#8217; %(repo_base, repo))</p>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(</dt>
<dd><dl class="first docutils">
<dt>json.dumps(</dt>
<dd>{&#8216;error&#8217;: str(e)}),</dd>
</dl>
<p class="last">content_type=&#8221;application/json&#8221;)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#8216;&#8217;&#8217;
Tables
&#8216;&#8217;&#8216;</p>
<p>&#64;login_required
def table(request, repo_base, repo, table):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">login = get_login(request)
dh_table_name = &#8216;%s.%s.%s&#8217; %(repo_base, repo, table)</p>
<p>&#8216;&#8217;&#8217;
res = DataHubManager.has_table_privilege(</p>
<blockquote>
<div>login, repo_base, dh_table_name, &#8216;SELECT&#8217;)</div></blockquote>
<dl class="docutils">
<dt>if not (res and res[&#8216;tuples&#8217;][0][0]):</dt>
<dd>raise Exception(&#8216;Access denied. Missing required privileges.&#8217;)</dd>
</dl>
<p>&#8216;&#8217;&#8217;
manager = DataHubManager(user=repo_base)
res = manager.execute_sql(</p>
<blockquote>
<div>query=&#8217;EXPLAIN SELECT * FROM %s&#8217; %(dh_table_name))</div></blockquote>
<p>limit = 50</p>
<p>num_rows = re.match(r&#8217;.*rows=(d+).*&#8217;, res[&#8216;tuples&#8217;][0][0]).group(1)
count = int(num_rows)</p>
<p>total_pages = 1 + (int(count) / limit)</p>
<p>current_page = 1
try:</p>
<blockquote>
<div>current_page = int(request.REQUEST[&#8216;page&#8217;])</div></blockquote>
<dl class="docutils">
<dt>except:</dt>
<dd>pass</dd>
<dt>if current_page &lt; 1:</dt>
<dd>current_page = 1</dd>
</dl>
<p>start_page = current_page - 5
if start_page &lt; 1:</p>
<blockquote>
<div>start_page = 1</div></blockquote>
<p>end_page = start_page + 10</p>
<dl class="docutils">
<dt>if end_page &gt; total_pages:</dt>
<dd>end_page = total_pages</dd>
</dl>
<p>print &#8220;&#8212;&#8212;&#8212;&#8212;-&#8221;
res = manager.execute_sql(</p>
<blockquote>
<div>query=&#8217;SELECT * from %s LIMIT %s OFFSET %s&#8217;
%(dh_table_name, limit, (current_page -1) * limit))</div></blockquote>
<p>column_names = [field[&#8216;name&#8217;] for field in res[&#8216;fields&#8217;]]
tuples = res[&#8216;tuples&#8217;]</p>
<p>annotation_text = None
url_path = &#8216;/browse/%s/%s/table/%s&#8217; %(repo_base, repo, table)
try:</p>
<blockquote>
<div>annotation = Annotation.objects.get(url_path=url_path)
annotation_text = annotation.annotation_text</div></blockquote>
<dl class="docutils">
<dt>except:</dt>
<dd>pass</dd>
<dt>data = {</dt>
<dd>&#8216;login&#8217;: get_login(request),
&#8216;repo_base&#8217;: repo_base,
&#8216;repo&#8217;: repo,
&#8216;table&#8217;: table,
&#8216;column_names&#8217;: column_names,
&#8216;tuples&#8217;: tuples,
&#8216;annotation&#8217;: annotation_text,
&#8216;current_page&#8217;: current_page,
&#8216;next_page&#8217;: current_page + 1,
&#8216;prev_page&#8217;: current_page - 1,
&#8216;url_path&#8217;: url_path,
&#8216;total_pages&#8217;: total_pages,
&#8216;pages&#8217;: range(start_page, end_page + 1)}</dd>
</dl>
<p class="last">data.update(csrf(request))
return render_to_response(&#8220;table-browse.html&#8221;, data)</p>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(json.dumps(</dt>
<dd>{&#8216;error&#8217;: str(e)}),
content_type=&#8221;application/json&#8221;)</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#64;login_required
def table_export(request, repo_base, repo, table_name):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">login = get_login(request)
res = DataHubManager.has_repo_privilege(login, repo_base, repo, &#8216;CREATE&#8217;)</p>
<dl class="docutils">
<dt>if not (res and res[&#8216;tuples&#8217;][0][0]):</dt>
<dd>raise Exception(&#8216;Access denied. Missing required privileges.&#8217;)</dd>
</dl>
<p>repo_dir = &#8216;/user_data/%s/%s&#8217; %(repo_base, repo)</p>
<dl class="docutils">
<dt>if not os.path.exists(repo_dir):</dt>
<dd>os.makedirs(repo_dir)</dd>
</dl>
<p>file_path = &#8216;%s/%s.csv&#8217; %(repo_dir, table_name)
dh_table_name = &#8216;%s.%s.%s&#8217; %(repo_base, repo, table_name)
DataHubManager.export_table(</p>
<blockquote>
<div>repo_base=repo_base, table_name=dh_table_name, file_path=file_path)</div></blockquote>
<p class="last">return HttpResponseRedirect(&#8216;/browse/%s/%s/files&#8217; %(repo_base, repo))</p>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(</dt>
<dd><dl class="first docutils">
<dt>json.dumps(</dt>
<dd>{&#8216;error&#8217;: str(e)}),</dd>
</dl>
<p class="last">content_type=&#8221;application/json&#8221;)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#64;login_required
def table_delete(request, repo_base, repo, table_name):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">login = get_login(request)
dh_table_name = &#8216;%s.%s.%s&#8217; %(repo_base, repo, table_name)</p>
<dl class="docutils">
<dt>res = DataHubManager.has_table_privilege(</dt>
<dd>login, repo_base, dh_table_name, &#8216;DELETE&#8217;)</dd>
<dt>if not (res and res[&#8216;tuples&#8217;][0][0]):</dt>
<dd>raise Exception(&#8216;Access denied. Missing required privileges.&#8217;)</dd>
</dl>
<p>manager = DataHubManager(user=repo_base)</p>
<p class="last">query = &#8216;&#8217;&#8216;DROP TABLE %s&#8217;&#8216;&#8217; %(dh_table_name)
manager.execute_sql(query=query)
return HttpResponseRedirect(&#8216;/browse/%s/%s&#8217; %(repo_base, repo))</p>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(</dt>
<dd><dl class="first docutils">
<dt>json.dumps(</dt>
<dd>{&#8216;error&#8217;: str(e)}),</dd>
</dl>
<p class="last">content_type=&#8221;application/json&#8221;)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#8216;&#8217;&#8217;
Files
&#8216;&#8217;&#8216;</p>
<dl class="docutils">
<dt>def file_save(repo_base, repo, data_file):</dt>
<dd><p class="first">repo_dir = &#8216;/user_data/%s/%s&#8217; %(repo_base, repo)
if not os.path.exists(repo_dir):</p>
<blockquote>
<div>os.makedirs(repo_dir)</div></blockquote>
<p>file_name = &#8216;%s/%s&#8217; %(repo_dir, data_file.name)
with open(file_name, &#8216;wb+&#8217;) as destination:</p>
<blockquote class="last">
<div><dl class="docutils">
<dt>for chunk in data_file.chunks():</dt>
<dd>destination.write(chunk)</dd>
</dl>
</div></blockquote>
</dd>
</dl>
<p>&#64;login_required
def file_upload(request, repo_base, repo):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd>data_file = request.FILES[&#8216;data_file&#8217;]
file_save(repo_base, repo, data_file)
return HttpResponseRedirect(&#8216;/browse/%s/%s/files&#8217; %(repo_base, repo))</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(</dt>
<dd><dl class="first docutils">
<dt>json.dumps(</dt>
<dd>{&#8216;error&#8217;: str(e)}),</dd>
</dl>
<p class="last">content_type=&#8221;application/json&#8221;)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#64;login_required
def file_import(request, repo_base, repo, file_name):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">login = get_login(request)
res = DataHubManager.has_repo_privilege(login, repo_base, repo, &#8216;CREATE&#8217;)</p>
<dl class="docutils">
<dt>if not (res and res[&#8216;tuples&#8217;][0][0]):</dt>
<dd>raise Exception(&#8216;Access denied. Missing required privileges.&#8217;)</dd>
</dl>
<p>delimiter = str(request.GET[&#8216;delimiter&#8217;])
if delimiter == &#8216;&#8217;:</p>
<blockquote>
<div>delimiter = str(request.GET[&#8216;other_delimiter&#8217;])</div></blockquote>
<p>header = True if request.GET[&#8216;has_header&#8217;] == &#8220;true&#8221; else False</p>
<p>quote_character = request.GET[&#8216;quote_character&#8217;]
if quote_character == &#8216;&#8217;:</p>
<blockquote>
<div>quote_character = request.GET[&#8216;other_quote_character&#8217;]</div></blockquote>
<p>delimiter = delimiter.decode(&#8216;string_escape&#8217;)</p>
<p>repo_dir = &#8216;/user_data/%s/%s&#8217; %(repo_base, repo)
file_path = &#8216;%s/%s&#8217; %(repo_dir, file_name)
table_name, _ = os.path.splitext(file_name)
table_name = clean_str(table_name, &#8216;table&#8217;)
dh_table_name = &#8216;%s.%s.%s&#8217; %(repo_base, repo, table_name)</p>
<p>f = codecs.open(file_path, &#8216;r&#8217;, &#8216;ISO-8859-1&#8217;)</p>
<p>data = csv.reader(f, delimiter=delimiter)
cells = data.next()</p>
<p>columns = [clean_str(str(i), &#8216;col&#8217;) for i in range(0, len(cells))]
if header:</p>
<blockquote>
<div>columns = map(lambda x: clean_str(x, &#8216;col&#8217;), cells)</div></blockquote>
<p>columns = rename_duplicates(columns)</p>
<p>query = &#8216;CREATE TABLE %s (%s text&#8217; % (dh_table_name, columns[0])</p>
<dl class="docutils">
<dt>for i in range(1, len(columns)):</dt>
<dd>query += &#8216;, %s %s&#8217; %(columns[i], &#8216;text&#8217;)</dd>
</dl>
<p>query += &#8216;)&#8217;</p>
<p>manager = DataHubManager(user=repo_base)
manager.execute_sql(query=query)
manager.import_file(</p>
<blockquote>
<div>repo_base=repo_base,
table_name=dh_table_name,
file_path=file_path,
delimiter=delimiter,
header=header,
quote_character=quote_character)</div></blockquote>
<p class="last">return HttpResponseRedirect(&#8216;/browse/%s/%s&#8217; %(repo_base, repo))</p>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(</dt>
<dd><dl class="first docutils">
<dt>json.dumps(</dt>
<dd>{&#8216;error&#8217;: str(e)}),</dd>
</dl>
<p class="last">content_type=&#8221;application/json&#8221;)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#64;login_required
def file_delete(request, repo_base, repo, file_name):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">login = get_login(request)
res = DataHubManager.has_repo_privilege(login, repo_base, repo, &#8216;CREATE&#8217;)</p>
<dl class="docutils">
<dt>if not (res and res[&#8216;tuples&#8217;][0][0]):</dt>
<dd>raise Exception(&#8216;Access denied. Missing required privileges.&#8217;)</dd>
</dl>
<p class="last">repo_dir = &#8216;/user_data/%s/%s&#8217; %(repo_base, repo)
file_path = &#8216;%s/%s&#8217; %(repo_dir, file_name)
os.remove(file_path)
return HttpResponseRedirect(&#8216;/browse/%s/%s/files&#8217; %(repo_base, repo))</p>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(</dt>
<dd><dl class="first docutils">
<dt>json.dumps(</dt>
<dd>{&#8216;error&#8217;: str(e)}),</dd>
</dl>
<p class="last">content_type=&#8221;application/json&#8221;)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#64;login_required
def file_download(request, repo_base, repo, file_name):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">repo_dir = &#8216;/user_data/%s/%s&#8217; %(repo_base, repo)
file_path = &#8216;%s/%s&#8217; %(repo_dir, file_name)
response = HttpResponse(</p>
<blockquote>
<div>open(file_path).read(), content_type=&#8217;application/force-download&#8217;)</div></blockquote>
<p class="last">response[&#8216;Content-Disposition&#8217;] = &#8216;attachment; filename=&#8221;%s&#8221;&#8217; %(file_name)
return response</p>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(</dt>
<dd><dl class="first docutils">
<dt>json.dumps(</dt>
<dd>{&#8216;error&#8217;: str(e)}),</dd>
</dl>
<p class="last">content_type=&#8221;application/json&#8221;)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#8216;&#8217;&#8217;
Query
&#8216;&#8217;&#8217;
&#64;login_required
def query(request, repo_base, repo):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">login = get_login(request)
data = {</p>
<blockquote>
<div>&#8216;login&#8217;: get_login(request),
&#8216;repo_base&#8217;: repo_base,
&#8216;repo&#8217;: repo,
&#8216;select_query&#8217;: False,
&#8216;query&#8217;: None}</div></blockquote>
<p>data.update(csrf(request))</p>
<dl class="last docutils">
<dt>if &#8216;q&#8217; in request.REQUEST:</dt>
<dd><p class="first">query = request.REQUEST[&#8216;q&#8217;]
query = query.strip().rstrip(&#8216;;&#8217;)</p>
<p>manager = DataHubManager(user=repo_base)</p>
<p>select_query = False
if (query.split()[0]).lower() == &#8216;select&#8217;:</p>
<blockquote>
<div>select_query = True</div></blockquote>
<p>count = 0
limit = 50</p>
<dl class="docutils">
<dt>if select_query:</dt>
<dd>res = manager.execute_sql(query=&#8217;EXPLAIN %s&#8217; %(query))
num_rows = re.match(r&#8217;.*rows=(d+).*&#8217;, res[&#8216;tuples&#8217;][0][0]).group(1)
count = int(num_rows)</dd>
</dl>
<p>total_pages = 1 + (int(count) / limit)</p>
<p>current_page = 1
try:</p>
<blockquote>
<div>current_page = int(request.REQUEST[&#8216;page&#8217;])</div></blockquote>
<dl class="docutils">
<dt>except:</dt>
<dd>pass</dd>
<dt>if current_page &lt; 1:</dt>
<dd>current_page = 1</dd>
</dl>
<p>start_page = current_page - 5
if start_page &lt; 1:</p>
<blockquote>
<div>start_page = 1</div></blockquote>
<p>end_page = start_page + 10</p>
<dl class="docutils">
<dt>if end_page &gt; total_pages:</dt>
<dd>end_page = total_pages</dd>
</dl>
<p>db_query = query</p>
<dl class="docutils">
<dt>if select_query:</dt>
<dd><p class="first"># wrap query in another select statement, to allow the
# user&#8217;s LIMIT statements to still work
db_query = &#8216;select * from (&#8216; + query + &#8216;) as BXCQWVPEMWVKFBEBNKZSRPYBSB&#8217;</p>
<p># wrap in datahub limit and offset statements, to support pagination
db_query = &#8216;%s LIMIT %s OFFSET %s&#8217; %(</p>
<blockquote class="last">
<div>db_query, limit, (current_page -1) * limit)</div></blockquote>
</dd>
</dl>
<p>res = manager.execute_sql(query=db_query)</p>
<dl class="docutils">
<dt>if select_query or res[&#8216;row_count&#8217;] &gt; 0:</dt>
<dd>column_names = [field[&#8216;name&#8217;] for field in res[&#8216;fields&#8217;]]
tuples = res[&#8216;tuples&#8217;]</dd>
<dt>else:</dt>
<dd>column_names = [&#8216;status&#8217;]
tuples = [[&#8216;success&#8217; if res[&#8216;status&#8217;] else res[&#8216;error&#8217;]]]</dd>
</dl>
<p>url_path = &#8216;/browse/%s/%s/query&#8217; %(repo_base, repo)</p>
<dl class="docutils">
<dt>data.update({</dt>
<dd>&#8216;select_query&#8217;: select_query,
&#8216;query&#8217;: query,
&#8216;column_names&#8217;: column_names,
&#8216;tuples&#8217;: tuples,
&#8216;url_path&#8217;: url_path,
&#8216;current_page&#8217;: current_page,
&#8216;next_page&#8217;: current_page + 1,
&#8216;prev_page&#8217;: current_page - 1,
&#8216;total_pages&#8217;: total_pages,
&#8216;pages&#8217;: range(start_page, end_page + 1)})</dd>
</dl>
<p class="last">return render_to_response(&#8220;query-browse-results.html&#8221;, data)</p>
</dd>
<dt>else:</dt>
<dd>return render_to_response(&#8220;query.html&#8221;, data)</dd>
</dl>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(</dt>
<dd><dl class="first docutils">
<dt>json.dumps(</dt>
<dd>{&#8216;error&#8217;: str(e)}),</dd>
</dl>
<p class="last">content_type=&#8221;application/json&#8221;)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#8216;&#8217;&#8217;
Annotations
&#8216;&#8217;&#8216;</p>
<p>&#64;login_required
def create_annotation(request):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">url = request.POST[&#8216;url&#8217;]
annotation_text = request.POST[&#8216;annotation&#8217;]</p>
<dl class="docutils">
<dt>try:</dt>
<dd>annotation = Annotation.objects.get(url_path=url)
annotation.annotation_text = annotation_text
annotation.save()</dd>
<dt>except Annotation.DoesNotExist:</dt>
<dd><dl class="first docutils">
<dt>annotation = Annotation(</dt>
<dd>url_path=url, annotation_text=annotation_text)</dd>
</dl>
<p class="last">annotation.save()</p>
</dd>
</dl>
<p class="last">return HttpResponseRedirect(url)</p>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(</dt>
<dd><dl class="first docutils">
<dt>json.dumps(</dt>
<dd>{&#8216;error&#8217;: str(e)}),</dd>
</dl>
<p class="last">content_type=&#8221;application/json&#8221;)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#8216;&#8217;&#8217;
Cards
&#8216;&#8217;&#8216;</p>
<p>&#64;login_required
def card(request, repo_base, repo, card_name):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">login = get_login(request)
card = Card.objects.get(repo_base=repo_base, repo_name=repo, card_name=card_name)
query = card.query
manager = DataHubManager(user=repo_base)
res = manager.execute_sql(</p>
<blockquote>
<div>query=&#8217;EXPLAIN %s&#8217; %(query))</div></blockquote>
<p>limit = 50</p>
<p>num_rows = re.match(r&#8217;.*rows=(d+).*&#8217;, res[&#8216;tuples&#8217;][0][0]).group(1)
count = int(num_rows)
total_pages = 1 + (int(count) / limit)</p>
<p>current_page = 1
try:</p>
<blockquote>
<div>current_page = int(request.REQUEST[&#8216;page&#8217;])</div></blockquote>
<dl class="docutils">
<dt>except:</dt>
<dd>pass</dd>
<dt>if current_page &lt; 1:</dt>
<dd>current_page = 1</dd>
</dl>
<p>start_page = current_page - 5
if start_page &lt; 1:</p>
<blockquote>
<div>start_page = 1</div></blockquote>
<p>end_page = start_page + 10</p>
<dl class="docutils">
<dt>if end_page &gt; total_pages:</dt>
<dd>end_page = total_pages</dd>
</dl>
<p># wrap query in another select statement, to allow the
# user&#8217;s LIMIT statements to still work
db_query = &#8216;select * from (&#8216; + query + &#8216;) as BXCQWVPEMWVKFBEBNKZSRPYBSB&#8217;
db_query = &#8216;%s LIMIT %s OFFSET %s&#8217; %(db_query, limit, (current_page -1) * limit)</p>
<p>res = manager.execute_sql(query=db_query)</p>
<p>column_names = [field[&#8216;name&#8217;] for field in res[&#8216;fields&#8217;]]
tuples = res[&#8216;tuples&#8217;]</p>
<p>annotation_text = None
url_path = &#8216;/browse/%s/%s/card/%s&#8217; %(repo_base, repo, card_name)
try:</p>
<blockquote>
<div>annotation = Annotation.objects.get(url_path=url_path)
annotation_text = annotation.annotation_text</div></blockquote>
<dl class="docutils">
<dt>except:</dt>
<dd>pass</dd>
<dt>data = {</dt>
<dd>&#8216;login&#8217;: get_login(request),
&#8216;repo_base&#8217;: repo_base,
&#8216;repo&#8217;: repo,
&#8216;card_name&#8217;: card_name,
&#8216;annotation&#8217;: annotation_text,
&#8216;query&#8217;: query,
&#8216;column_names&#8217;: column_names,
&#8216;tuples&#8217;: tuples,
&#8216;url_path&#8217;: url_path,
&#8216;current_page&#8217;: current_page,
&#8216;next_page&#8217;: current_page + 1,
&#8216;prev_page&#8217;: current_page - 1,
&#8216;total_pages&#8217;: total_pages,
&#8216;pages&#8217;: range(start_page, end_page + 1)}</dd>
</dl>
<p class="last">data.update(csrf(request))
return render_to_response(&#8220;card-browse.html&#8221;, data)</p>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(</dt>
<dd><dl class="first docutils">
<dt>json.dumps(</dt>
<dd>{&#8216;error&#8217;: str(e)}),</dd>
</dl>
<p class="last">content_type=&#8221;application/json&#8221;)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#64;login_required
def card_create(request, repo_base, repo):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">card_name = request.POST[&#8216;card-name&#8217;]
query = request.POST[&#8216;query&#8217;]
url = &#8216;/browse/%s/%s/card/%s&#8217; %(repo_base, repo, card_name)</p>
<dl class="docutils">
<dt>card = Card(</dt>
<dd>repo_base=repo_base, repo_name=repo, card_name=card_name, query=query)</dd>
</dl>
<p class="last">card.save()
return HttpResponseRedirect(url)</p>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(</dt>
<dd><dl class="first docutils">
<dt>json.dumps(</dt>
<dd>{&#8216;error&#8217;: str(e)}),</dd>
</dl>
<p class="last">content_type=&#8221;application/json&#8221;)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#64;login_required
def card_export(request, repo_base, repo, card_name):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">login = get_login(request)
card = Card.objects.get(repo_base=repo_base, repo_name=repo, card_name=card_name)
query = card.query
res = DataHubManager.has_repo_privilege(login, repo_base, repo, &#8216;CREATE&#8217;)</p>
<dl class="docutils">
<dt>if not (res and res[&#8216;tuples&#8217;][0][0]):</dt>
<dd>raise Exception(&#8216;Access denied. Missing required privileges.&#8217;)</dd>
</dl>
<p>repo_dir = &#8216;/user_data/%s/%s&#8217; %(repo_base, repo)</p>
<dl class="docutils">
<dt>if not os.path.exists(repo_dir):</dt>
<dd>os.makedirs(repo_dir)</dd>
</dl>
<p>file_path = &#8216;%s/%s.csv&#8217; %(repo_dir, card_name)
DataHubManager.export_query(</p>
<blockquote>
<div>repo_base=repo_base, query=query, file_path=file_path)</div></blockquote>
<p class="last">return HttpResponseRedirect(&#8216;/browse/%s/%s/files&#8217; %(repo_base, repo))</p>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(</dt>
<dd><dl class="first docutils">
<dt>json.dumps(</dt>
<dd>{&#8216;error&#8217;: str(e)}),</dd>
</dl>
<p class="last">content_type=&#8221;application/json&#8221;)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#64;login_required
def card_delete(request, repo_base, repo, card_name):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">login = get_login(request)
res = DataHubManager.has_repo_privilege(login, repo_base, repo, &#8216;CREATE&#8217;)</p>
<dl class="docutils">
<dt>if not (res and res[&#8216;tuples&#8217;][0][0]):</dt>
<dd>raise Exception(&#8216;Access denied. Missing required privileges.&#8217;)</dd>
</dl>
<p>card = Card.objects.get(repo_base=repo_base, repo_name=repo, card_name=card_name)
card.delete()</p>
<p class="last">return HttpResponseRedirect(&#8216;/browse/%s/%s/cards&#8217; %(repo_base, repo))</p>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(</dt>
<dd><dl class="first docutils">
<dt>json.dumps(</dt>
<dd>{&#8216;error&#8217;: str(e)}),</dd>
</dl>
<p class="last">content_type=&#8221;application/json&#8221;)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>&#8216;&#8217;&#8217;
Developer Apps
&#8216;&#8217;&#8216;</p>
<p>&#64;login_required
def apps (request):</p>
<blockquote>
<div><p>login = get_login(request)
user = User.objects.get(username=login)
user_apps = App.objects.filter(user=user)
apps = []
for app in user_apps:</p>
<blockquote>
<div><dl class="docutils">
<dt>apps.append(</dt>
<dd>{&#8216;app_id&#8217;: app.app_id,
&#8216;app_name&#8217;: app.app_name,
&#8216;app_token&#8217;: app.app_token,
&#8216;date_created&#8217;: app.timestamp})</dd>
</dl>
</div></blockquote>
<p>print apps
c = {</p>
<blockquote>
<div>&#8216;login&#8217;: login,
&#8216;apps&#8217;: apps}</div></blockquote>
<p>return render_to_response(&#8216;apps.html&#8217;, c)</p>
</div></blockquote>
<p>&#64;login_required
def app_register (request):</p>
<blockquote>
<div><p>login = get_login(request)</p>
<dl class="docutils">
<dt>if request.method == &#8220;POST&#8221;:</dt>
<dd><dl class="first last docutils">
<dt>try:</dt>
<dd><p class="first">user = User.objects.get(username=login)
app_id = request.POST[&#8220;app-id&#8221;].lower()
app_name = request.POST[&#8220;app-name&#8221;]
app_token = str(uuid.uuid4())
app = App(</p>
<blockquote>
<div>app_id=app_id, app_name=app_name, user=user, app_token=app_token)</div></blockquote>
<p>app.save()</p>
<dl class="docutils">
<dt>try:</dt>
<dd><p class="first">hashed_password = hashlib.sha1(app_token).hexdigest()
DataHubManager.create_user(</p>
<blockquote class="last">
<div>username=app_id, password=hashed_password, create_db=False)</div></blockquote>
</dd>
<dt>except Exception, e:</dt>
<dd>app.delete()
raise e</dd>
</dl>
<p class="last">return HttpResponseRedirect(&#8216;/developer/apps&#8217;)</p>
</dd>
<dt>except Exception, e:</dt>
<dd><dl class="first docutils">
<dt>c = {</dt>
<dd>&#8216;login&#8217;: login,
&#8216;errors&#8217;: [str(e)]}</dd>
</dl>
<p class="last">c.update(csrf(request))
return render_to_response(&#8216;app-create.html&#8217;, c)</p>
</dd>
</dl>
</dd>
<dt>else:</dt>
<dd>c = {&#8216;login&#8217;: login}
c.update(csrf(request))
return render_to_response(&#8216;app-create.html&#8217;, c)</dd>
</dl>
</div></blockquote>
<p>&#64;login_required
def app_remove (request, app_id):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">login = get_login(request)
user = User.objects.get(username=login)
app = App.objects.get(user=user, app_id=app_id)
app.delete()</p>
<p>DataHubManager.remove_user(username=app_id)</p>
<p class="last">return HttpResponseRedirect(&#8216;/developer/apps&#8217;)</p>
</dd>
<dt>except Exception, e:</dt>
<dd>c = {&#8216;errors&#8217;: [str(e)]}
c.update(csrf(request))
return render_to_response(&#8216;apps.html&#8217;, c)</dd>
</dl>
</div></blockquote>
<p>&#64;login_required
def app_allow_access(request, app_id, repo_name):</p>
<blockquote>
<div><p>login = get_login(request)
try:</p>
<blockquote>
<div><p>app = None
try:</p>
<blockquote>
<div>app = App.objects.get(app_id=app_id)</div></blockquote>
<dl class="docutils">
<dt>except App.DoesNotExist:</dt>
<dd>raise Exception(&#8220;Invalid app_id&#8221;)</dd>
</dl>
<p>app = App.objects.get(app_id=app_id)</p>
<p>redirect_url = None</p>
<dl class="docutils">
<dt>if &#8216;redirect_url&#8217; in request.REQUEST:</dt>
<dd>redirect_url = request.REQUEST[&#8216;redirect_url&#8217;]</dd>
</dl>
<p>if request.method == &#8220;POST&#8221;:</p>
<blockquote>
<div><p>access_val = request.POST[&#8216;access_val&#8217;]</p>
<dl class="docutils">
<dt>if access_val == &#8216;allow&#8217;:</dt>
<dd>account_grant_permission(
username=login,
repo_name=repo_name,
app_id=app_id,
app_token=app.app_token)</dd>
<dt>if redirect_url:</dt>
<dd>redirect_url = redirect_url + urllib.unquote_plus(&#8216;?auth_user=%s&#8217; %(login))
return HttpResponseRedirect(redirect_url)</dd>
<dt>else:</dt>
<dd><dl class="first last docutils">
<dt>if access_val == &#8216;allow&#8217;:</dt>
<dd>return HttpResponseRedirect(&#8216;/settings/%s/%s&#8217; %(login, repo_name))</dd>
<dt>else:</dt>
<dd><dl class="first docutils">
<dt>res = {</dt>
<dd>&#8216;msg_title&#8217;: &#8216;Access Request&#8217;,
&#8216;msg_body&#8217;: &#8216;Permission denied to the app %s.&#8217; %(app_id)</dd>
</dl>
<p class="last">}
return render_to_response(&#8216;confirmation.html&#8217;, res)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<dl class="docutils">
<dt>else:</dt>
<dd><dl class="first docutils">
<dt>res = {</dt>
<dd>&#8216;login&#8217;: login,
&#8216;repo_name&#8217;: repo_name,
&#8216;app_id&#8217;: app_id,
&#8216;app_name&#8217;: app.app_name}</dd>
<dt>if &#8216;redirect_url&#8217; in request.REQUEST:</dt>
<dd>res[&#8216;redirect_url&#8217;] = request.REQUEST[&#8216;redirect_url&#8217;]</dd>
</dl>
<p class="last">res.update(csrf(request))
return render_to_response(&#8216;app-allow-access.html&#8217;, res)</p>
</dd>
</dl>
</div></blockquote>
<dl class="docutils">
<dt>except Exception, e:</dt>
<dd><dl class="first last docutils">
<dt>return HttpResponse(</dt>
<dd><dl class="first docutils">
<dt>json.dumps(</dt>
<dd>{&#8216;error&#8217;: str(e)}),</dd>
</dl>
<p class="last">content_type=&#8221;application/json&#8221;)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>


          </div>
        </div>
      </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/src/browser/views.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, MIT Living Lab.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.4</a>
      
      |
      <a href="../../_sources/src/browser/views.txt"
          rel="nofollow">Page source</a></li>
    </div>

    

    
  </body>
</html>