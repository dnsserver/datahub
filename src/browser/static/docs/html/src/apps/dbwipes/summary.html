<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>&lt;no title&gt; &mdash; DH_Doc 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="DH_Doc 0.1 documentation" href="../../../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">DH_Doc 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
    <h1> Generated by Sphinx </h1>
    
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <p>from functools import wraps
import json
import pdb</p>
<p>from core.db.manager import DataHubManager
from django.db import connection</p>
<p>from util import pick</p>
<dl class="docutils">
<dt>def get_cache(username):</dt>
<dd><dl class="first last docutils">
<dt>try:</dt>
<dd><p class="first">manager = DataHubManager(user=username)
manager.execute_sql(</p>
<blockquote class="last">
<div>&#8220;create table _dbwipes_cache(key varchar, val text)&#8221;)</div></blockquote>
</dd>
<dt>except:</dt>
<dd>pass</dd>
</dl>
</dd>
<dt>def make_cache(f):</dt>
<dd><p class="first">&#64;wraps(f)
def _f(self, <a href="#id1"><span class="problematic" id="id2">*</span></a>args, <a href="#id3"><span class="problematic" id="id4">**</span></a>kwargs):</p>
<blockquote>
<div><dl class="docutils">
<dt>try:</dt>
<dd><p class="first">key = str(map(str, (f.__name__, self.dbname, self.tablename, self.where, self.nbuckets, map(str, args))))
manager = DataHubManager(user=self.username)
vals = manager.execute_sql(</p>
<blockquote>
<div>&#8216;select val from _dbwipes_cache where key = %s&#8217;,
params = (key,))[&#8216;tuples&#8217;]</div></blockquote>
<dl class="last docutils">
<dt>if len(vals):</dt>
<dd>return json.loads(vals[0][0])</dd>
</dl>
</dd>
<dt>except Exception as e:</dt>
<dd>print e
pdb.set_trace()</dd>
</dl>
<p>res = f(self, <a href="#id5"><span class="problematic" id="id6">*</span></a>args, <a href="#id7"><span class="problematic" id="id8">**</span></a>kwargs)
if key:</p>
<blockquote>
<div><p>manager = DataHubManager(user=self.username)
manager.execute_sql(</p>
<blockquote>
<div>&#8216;insert into _dbwipes_cache values(%s, %s)&#8217;,
params = (key, json.dumps(res, default=json_handler)))</div></blockquote>
</div></blockquote>
<p>return res</p>
</div></blockquote>
<p class="last">return _f</p>
</dd>
<dt>def json_handler(o):</dt>
<dd><dl class="first last docutils">
<dt>if hasattr(o, &#8216;isoformat&#8217;):</dt>
<dd>return o.isoformat()</dd>
</dl>
</dd>
</dl>
<p>class Summary(object):</p>
<blockquote>
<div><dl class="docutils">
<dt>def __init__(self, dbname, tablename, username, nbuckets=50, where=&#8217;&#8216;):</dt>
<dd><p class="first">self.username = username
self.dbname = dbname
self.tablename = tablename
self.nbuckets = nbuckets
self.where = &#8216;&#8217;
where = where.strip()
if where:</p>
<blockquote>
<div>self.where = &#8216;WHERE %s&#8217; % where</div></blockquote>
<p># make sure cache exists
get_cache(username)</p>
<p class="last">self.nrows = self.get_num_rows()
self.col_types = self.get_columns_and_types()</p>
</dd>
<dt>def __call__(self):</dt>
<dd><p class="first">stats = []
for col, typ in self.col_types:</p>
<blockquote>
<div><p>#print &#8220;stats for: %st%s&#8221; % (col, typ)
col_stats = self.get_col_stats(col, typ)
if col_stats is None:</p>
<blockquote>
<div>#print &#8220;tgot None&#8221;
continue</div></blockquote>
<p>#print &#8220;tgot %d&#8221; % (len(col_stats))
stats.append((col, typ, col_stats))</p>
</div></blockquote>
<p class="last">return stats</p>
</dd>
<dt>def close(self):</dt>
<dd>pass</dd>
<dt>def reset_cache(self):</dt>
<dd>q = &#8220;&#8221;&#8220;delete from cache where key like &#8216;%%%%%s%%%%%s%%%%&#8217;&#8221;&#8220;&#8221; % (str(self.engine), self.tablename)
manager = DataHubManager(user=self.username)
manager.execute_sql(q)</dd>
<dt>def query(self, q, <a href="#id9"><span class="problematic" id="id10">*</span></a>args):</dt>
<dd>&#8220;&#8221;&#8221;
Summaries using other engines only need to override this method
&#8220;&#8221;&#8221;
manager = DataHubManager(user=self.username)
return manager.execute_sql(q, params=args)[&#8216;tuples&#8217;]</dd>
</dl>
<p>&#64;make_cache
def get_num_rows(self):</p>
<blockquote>
<div>q = &#8220;SELECT count(*) from %s&#8221; % self.tablename
return self.query(q)[0][0]</div></blockquote>
<p>&#64;make_cache
def get_distinct_count(self, col):</p>
<blockquote>
<div>q = &#8220;SELECT count(distinct %s) FROM %s %s&#8221; % (col, self.tablename, self.where)
return self.query(q)[0][0]</div></blockquote>
<p>&#64;make_cache
def get_column_counts(self, cols):</p>
<blockquote>
<div>q = &#8220;&#8221;&#8220;SELECT %s FROM %s&#8221;&#8220;&#8221;
select = [&#8220;count(distinct %s)&#8221; % col for col in cols]
select = &#8221;, &#8221;.join(select)
q = q % (select, self.tablename)
counts = tuple(self.query(q)[0])
return dict(zip(cols, counts))</div></blockquote>
<p>&#64;make_cache
def get_columns_and_types(self):</p>
<blockquote>
<div><p>manager = DataHubManager(user=self.username)
rows = manager.get_schema(self.tablename)[&#8216;tuples&#8217;]
ret = []
for col, typ in rows:</p>
<blockquote>
<div><dl class="docutils">
<dt>if typ == &#8216;text&#8217;:</dt>
<dd>typ = &#8216;str&#8217;</dd>
<dt>if &#8216;double&#8217; in typ:</dt>
<dd>typ = &#8216;num&#8217;</dd>
<dt>if &#8216;int&#8217; in typ:</dt>
<dd>typ = &#8216;num&#8217;</dd>
<dt>if &#8216;date&#8217; in typ or &#8216;time&#8217; in typ:</dt>
<dd>typ = &#8216;time&#8217;</dd>
</dl>
<p>ret.append((str(col), str(typ)) )</p>
</div></blockquote>
<p>return ret</p>
</div></blockquote>
<p>&#64;make_cache
def get_columns(self):</p>
<blockquote>
<div>&#8220;&#8221;&#8221;
engine specific way to get table columns
&#8220;&#8221;&#8221;
return pick(self.get_columns_and_types(), 0)</div></blockquote>
<p>&#64;make_cache
def get_type(self, col_name):</p>
<blockquote>
<div>return dict(self.get_columns_and_types()).get(col_name, None)</div></blockquote>
<dl class="docutils">
<dt>def get_col_groupby(self, col_name, col_type):</dt>
<dd><dl class="first docutils">
<dt>if col_type == None:</dt>
<dd>return None</dd>
</dl>
<p>groupby = None</p>
<dl class="docutils">
<dt>if &#8216;time&#8217; == col_type:</dt>
<dd>groupby = self.get_time_stats(col_name)</dd>
<dt>if &#8216;date&#8217; in col_type or &#8216;timestamp&#8217; in col_type:</dt>
<dd>groupby = self.get_date_stats(col_name)</dd>
</dl>
<p class="last">return groupby</p>
</dd>
</dl>
<p>&#64;make_cache
def get_col_stats(self, col_name, col_type=None):</p>
<blockquote>
<div><dl class="docutils">
<dt>if col_type is None:</dt>
<dd>col_type = self.get_type(col_name)</dd>
</dl>
<p>#if col_type.startswith(&#8216;_&#8217;):
#return None</p>
<p>numerics = [&#8216;int&#8217;, &#8216;float&#8217;, &#8216;double&#8217;, &#8216;numeric&#8217;, &#8216;num&#8217;]
is_numeric = any([s in col_type for s in numerics])
if is_numeric:</p>
<blockquote>
<div>stats = self.get_numeric_stats(col_name)
return stats</div></blockquote>
<dl class="docutils">
<dt>if any([s in col_type for s in [&#8216;char&#8217;, &#8216;text&#8217;, &#8216;str&#8217;]]):</dt>
<dd>return self.get_char_stats(col_name)</dd>
</dl>
<p>groupby = self.get_col_groupby(col_name, col_type)
if groupby:</p>
<blockquote>
<div>stats = self.get_group_stats(col_name, groupby)
return stats</div></blockquote>
<p>return None</p>
</div></blockquote>
<dl class="docutils">
<dt>def get_group_stats(self, col_name, groupby):</dt>
<dd>q = &#8220;&#8221;&#8220;select %s as GRP, min(%s), max(%s), count(*)
from %s  %s group by GRP
order by GRP limit %d&#8221;&#8220;&#8221;
q = q % (groupby, col_name, col_name, self.tablename, self.where, self.nbuckets)
rows = [{ &#8216;val&#8217;: x, &#8216;count&#8217;: count, &#8216;range&#8217;:[minv, maxv]} for (x, minv, maxv, count) in self.query(q)]
return rows</dd>
<dt>def get_numeric_stats(self, c):</dt>
<dd><p class="first">ndistinct = self.get_distinct_count(c)
if ndistinct == 0:</p>
<blockquote>
<div>return []</div></blockquote>
<dl class="docutils">
<dt>if ndistinct == 1:</dt>
<dd><dl class="first docutils">
<dt>if self.where:</dt>
<dd>q = &#8220;SELECT %s from %s %s AND %s is not null&#8221;
args = (c, self.tablename, self.where, c)</dd>
<dt>else:</dt>
<dd>q = &#8220;SELECT %s from %s WHERE %s is not null&#8221;
args = (c, self.tablename, c)</dd>
</dl>
<p class="last">val = self.query(q % args)[0][0]
return [{&#8216;val&#8217;: val, &#8216;count&#8217;: self.nrows, &#8216;range&#8217;: [val, val]}]</p>
</dd>
</dl>
<p>q = &#8220;&#8221;&#8221;
with bound as (</p>
<blockquote>
<div>SELECT min(%s) as min, max(%s) as max, avg(%s) as avg, stddev(%s) as std FROM %s %s</div></blockquote>
<p>)
SELECT width_bucket(%s::numeric, (avg-2.5*std), (avg+2.5*std), %d) as bucket,</p>
<blockquote>
<div>min(%s) as min,
max(%s) as max,
count(*) as count</div></blockquote>
<p>FROM %s, bound
%s
GROUP BY bucket
&#8220;&#8221;&#8221;
q = q % (c, c, c, c, self.tablename, self.where, c, self.nbuckets, c, c, self.tablename, self.where)</p>
<p>q = &#8220;&#8221;&#8221;
with TMP as (</p>
<blockquote>
<div>SELECT 2.5 * stddev(%s) / %d as block FROM %s %s</div></blockquote>
<p>)
SELECT (%s/block)::int*block as bucket,</p>
<blockquote>
<div>min(%s) as min,
max(%s) as max,
count(*) as count</div></blockquote>
<p>FROM %s,  TMP
%s
GROUP BY bucket
ORDER BY bucket
&#8220;&#8221;&#8221;
q = q % (c, self.nbuckets, self.tablename, self.where, c, c, c, self.tablename, self.where)</p>
<p>stats = []
for (val, minv, maxv, count) in self.query(q):</p>
<blockquote>
<div><dl class="docutils">
<dt>if val is None:</dt>
<dd><dl class="first docutils">
<dt>stats.append({</dt>
<dd>&#8216;val&#8217;: None,
&#8216;count&#8217;: count,
&#8216;range&#8217;: [minv, maxv]</dd>
</dl>
<p class="last">})</p>
</dd>
<dt>else:</dt>
<dd><dl class="first docutils">
<dt>stats.append({</dt>
<dd>&#8216;val&#8217;: (maxv+minv)/2.,
&#8216;count&#8217;: count,
&#8216;range&#8217;: [minv, maxv]</dd>
</dl>
<p class="last">})</p>
</dd>
</dl>
</div></blockquote>
<p class="last">return stats</p>
</dd>
<dt>def get_char_stats(self, col_name):</dt>
<dd><p class="first">q = &#8220;&#8221;&#8220;select %s as GRP, min(%s), max(%s), count(*)
FROM %s
%s
GROUP BY GRP
ORDER BY count(*) desc
LIMIT %d&#8221;&#8220;&#8221;
q = q % (col_name, col_name, col_name, self.tablename, self.where, self.nbuckets)
rows = [{ &#8216;val&#8217;: x, &#8216;count&#8217;: count, &#8216;range&#8217;:[minv, maxv]} for (x, minv, maxv, count) in self.query(q)]
return rows</p>
<p class="last">groupby = col_name
return groupby
return self.get_group_stats(col_name, groupby)</p>
</dd>
<dt>def get_time_stats(self, col_name):</dt>
<dd>return &#8220;date_trunc(&#8216;hour&#8217;, %s)::time&#8221; % col_name</dd>
<dt>def get_date_stats(self, col_name):</dt>
<dd><p class="first">q = &#8220;select max(%s)::date, min(%s)::date, EXTRACT(EPOCH FROM (max(%s::timestamp) - min(%s::timestamp)))/60 as minutes from %s&#8221;
q = q % (col_name, col_name, col_name, col_name,  self.tablename)
(maxv, minv, nminutes) = self.query(q)[0]
if maxv is None or minv is None or nminutes is None:</p>
<blockquote>
<div>return None</div></blockquote>
<p>ndays = nminutes / 60 / 24</p>
<p>var = &#8220;%s::timestamp&#8221; % col_name</p>
<dl class="docutils">
<dt>if ndays == 0:</dt>
<dd>groupby = &#8220;date_trunc(&#8216;hour&#8217;, %s)&#8221; % var</dd>
<dt>elif ndays &lt;= 30:</dt>
<dd>groupby = &#8220;date_trunc(&#8216;day&#8217;, %s)&#8221; % var</dd>
<dt>elif ndays &lt;= 50 * 7:</dt>
<dd>groupby = &#8220;date_trunc(&#8216;week&#8217;, %s)&#8221; % var</dd>
<dt>elif ndays &lt;= 365 * 12:</dt>
<dd>groupby = &#8220;date_trunc(&#8216;month&#8217;, %s)&#8221; % var</dd>
<dt>else:</dt>
<dd>groupby = &#8220;date_trunc(&#8216;year&#8217;, %s)&#8221; % var</dd>
</dl>
<p class="last">return groupby</p>
</dd>
</dl>
</div></blockquote>


          </div>
        </div>
      </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../_sources/src/apps/dbwipes/summary.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, MIT Living Lab.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.4</a>
      
      |
      <a href="../../../_sources/src/apps/dbwipes/summary.txt"
          rel="nofollow">Page source</a></li>
    </div>

    

    
  </body>
</html>